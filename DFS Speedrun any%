# Définir les variables
$sharePath = "\\hq.wsl2024.org\users"
$localPath = "D:\shares\datausers"
$quotaSize = 20MB
$driveLetter = "U:"

# Créer le dossier local
New-Item -ItemType Directory -Path $localPath -Force

# Créer le partage
New-SmbShare -Name "users" -Path $localPath -FullAccess "BUILTIN\Administrators" -ChangeAccess "BUILTIN\Users" -Description "Home Drives for wsl2024.org users" -Force

# Définir les autorisations sur le dossier local
$administratorsAcl = New-Object System.Security.AccessControl.FileSystemAccessRule("BUILTIN\Administrators", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
$usersAcl = New-Object System.Security.AccessControl.FileSystemAccessRule("BUILTIN\Users", "Modify", "ContainerInherit,ObjectInherit", "None", "Allow")
$domainUsersAcl = New-Object System.Security.AccessControl.FileSystemAccessRule("$env:USERDOMAIN\Users", "ReadAndExecute", "ContainerInherit,ObjectInherit", "None", "Allow")

Set-Acl -Path $localPath -AclObject $administratorsAcl
Set-Acl -Path $localPath -AclObject $usersAcl

# Créer un dossier pour chaque utilisateur dans le partage
Get-ADUser -Filter * | ForEach-Object {
    $username = $_.SamAccountName
    $userFolderPath = Join-Path $localPath $username
    New-Item -ItemType Directory -Path $userFolderPath | Out-Null
    Set-Acl -Path $userFolderPath -AclObject $domainUsersAcl
}

# Définir le quota
Set-FsrmQuota -Path $localPath -SizeLimit $quotaSize -Enforce -SourceTemplate "Hard"

# Restreindre les fichiers exécutables
$executableFilter = "*.exe", "*.msi", "*.bat"
New-FsrmFileGroup -Name "Executable Files" -IncludePattern $executableFilter
Set-FsrmFileScreen -Path $localPath -IncludeFileGroup "Executable Files" -Active

# Monter le partage sur la lettre U:
net use $driveLetter $sharePath

Write-Host "Le partage a été configuré avec succès."
